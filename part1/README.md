# Тема 1
## Оглавление
1. [Початкові налаштування](#r1)
2. [Базове наповнення Product.wxs файлу](#r2)
2. [Локалізація](#r3)
3. [Додавання діалогових вікон](#r4)
    - [Самостійне додавання - НЕ РОЗГЛЯНУТО](#r4_1)
    - [Використання готового набору](#4_2)
6. [Посилання](#r6)
______


## <a name="r1">Початкові налаштування</a>
Необхідно завантажити та встановити
- WiX Toolset - https://wixtoolset.org/ За посиланням переходимо в секцію завантажень та знаходимо актуальну на зараз версію. Після цього потрапляємо на сторінку в git де в розділі асетів знаходимо та завантажуємо exe файл
- Компонент .NET Framework. Після запуску інсталяції WiX він може просигналізувати, що не вистачає цього компоненту та вкаже потрібну версію. ЇЇ можна нагуглити в прив'язці до потрібної версії ОС. Посилання варто брати з сайту Майкрософт
- Для інтеграції у VS знаходим розширення для потрібної версії студії тут https://marketplace.visualstudio.com/items?itemName=WixToolset.WiXToolset Завантажуємо та встановлюємо його
- При створенні проекту обираємо Setup Project for WiX

## <a name="r2">Базове наповнення Product.wxs файлу</a>
Після створення проекту ми отримуємо Product.wxs файл з наступним вмістом
~~~wxs
<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
	<Product Id="*" Name="task1_CommonInfo" Language="1033" Version="1.0.0.0" Manufacturer="" UpgradeCode="97028dd3-6ab9-4122-a8a0-a347be02bd28">
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />

		<MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
		<MediaTemplate />

		<Feature Id="ProductFeature" Title="task1_CommonInfo" Level="1">
			<ComponentGroupRef Id="ProductComponents" />
		</Feature>

	</Product>

	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="ProgramFilesFolder">
				<Directory Id="INSTALLFOLDER" Name="task1_CommonInfo" />
			</Directory>
		</Directory>
	</Fragment>

	<Fragment>
		<ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
			<!-- TODO: Remove the comments around this Component element and the ComponentRef below in order to add resources to this installer. -->
			<!-- <Component Id="ProductComponent"> -->
				<!-- TODO: Insert files, registry keys, and other resources here. -->
			<!-- </Component> -->
		</ComponentGroup>
	</Fragment>
</Wix>

~~~
Розберемо призначення кожного рядку:
~~~wxs
<?xml version="1.0" encoding="UTF-8"?>
~~~
Це декларація XML документа, яка вказує парсеру XML на те, що він має робити з файлом.  
В даному випадку, цей рядок означає, що ми маємо справу з XML файлом версії 1.0 та що використовується кодування UTF-8 для символів в цьому файлі.
___
~~~wxs
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
~~~
Фактично вказівка на те, що даний файл є WiX файлом. Він має простір імен "http://schemas.microsoft.com/wix/2006/wi", який вказує на версію Wix, що використовується в файлі (2006 рік).

Цей рядок має синтаксичне значення для парсера XML, який відповідає за зчитування вихідного коду Wix. Він гарантує, що файл буде правильно проаналізований і опрацьований програмним забезпеченням Wix, що буде використовуватися для створення MSI-пакету.
___
~~~wxs
<Product Id="*" Name="task1_CommonInfo" Language="1058" Version="1.0.0.0" Manufacturer="" UpgradeCode="97028dd3-6ab9-4122-a8a0-a347be02bd28">
~~~
**Product** це елемент (також ключ, або тег) в мові розмітки XML. Значення в середині є атрибутами цього елементу:
- `Id` - унікальний ідентифікатор продукту GUID, що дозволяє визначити його в системі. Це спеціальний шістнадцятковий ключ. За замовчуванням в ньому стоїть значення `*` що говорить WiX автоматично згенерувати його. Однак в такому випадку кожний раз буде генеруватись новий ключ. Це добре якщо забуваєш змінити ключ від продукту до продукту. Але для одного конкретного продукту цей ключ має бути однаковим протягом всього часу його існування. Тож його треба генерувати самостійно. Якщо між версіями продукту змінити id, він буде вважатись новим та система встановить новую версію поряд зі старою. Технічно цей ідентифікатор може міститись в коді самого продукту.
- `Name` - назва продукту. За замовчуванням сюди підставлено назву проекту. Звичайно за потреби необхідно вказати назву продукту самостійно
- `Language` - код мови продукту. За замовчуванням тут знаходиться код англійської мови (1033). Цей параметр встановлює мову, яку використовує інсталятор для свого інтерфейсу та повідомлень
- `Version` - версія продукту. Використовується наприклад для перевірки чи встановлена вже більш рання чи пізня версія продукту. А також для сумісності між різними операційними системами
- `Manufacturer` - виробник продукту
- `UpgradeCode` - унікальний 16-вий ідентифікатор GUID. Він має залишатись однаковим протягом всього існування продукту. Саме перевіряючи однаковість цього ідентифікатору, система розумію чи встановлює новий продукт, чи оновлює старий. Якщо для різних версій одного продукту використати різний UpgradeCode це призведе до встановлення цих версій паралельно. Це значення генерується при створенні проекту автоматично

Окрім того, ключ *Product* може містити також наступні атрибути:
- `Codepage`: вказує кодову сторінку, яку слід використовувати для розкодування текстових рядків. За замовчуванням використовується кодова сторінка Windows-1252;
- `Comments`: містить коментарі до продукту;
- `Keywords`: вказує ключові слова, що допомагають користувачам знайти продукт у пошукових системах;
- `Description`: містить опис продукту;
- `Licensing`: вказує тип ліцензії для продукту;
- `ManufacturerUrl`: містить URL-адресу виробника продукту;
- `HelpTelephone`: вказує телефонну підтримку для продукту;
- `HelpLink`: містить посилання на сторінку підтримки продукту;
- `UpdateUrl`: містить URL-адресу для перевірки наявності оновлень для продукту;
___
~~~wxs
<Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
~~~
**Package** - ключ, який відповідає за налаштування пакета, що буде створений при компіляції проекту за допомогою Wix Toolset
- `InstallerVersion` - вказує версію Windows Installer, яку необхідно використовувати для встановлення пакету. У цьому випадку використовується версія 2.0.
- `Compressed` - вказує, що файли у пакеті повинні бути стиснуті. Це зменшує розмір пакету і поліпшує час завантаження
- `InstallScope` - визначає область, в яку буде встановлений продукт, має два значення:
    - perUser - встановлення буде доступне лише для користувача, який встановив продукт
    - perMachine - встановлення буде доступне для всіх користувачів, які використовують комп'ютер

Окрім того, ключ *Package* може містити також наступні атрибути:
- `InstallPrivileges`- вказує, чи потрібно запускати інсталятор в режимі підвищених привілеїв. Можливі значення: *limited* (запустити в обмеженому режимі), *elevated* (запустити з підвищеними привілеями), *elevatedRequireSignature* (запустити з підвищеними привілеями, якщо встановлено цифровий підпис);
- `Languages`- дозволяє вказати список мов, які повинні бути встановлені разом з продуктом;
- `SummaryCodepage`- вказує кодування для короткого опису продукту.
___
~~~wxs
<MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
~~~
**MajorUpgrade** - це ключ, який залежить від атрибуту *Version* ключа *Product* та працює тільки у випадку оновлення продукту. Ключ:
- `DowngradeErrorMessage` - вказує яке повідомлення буде виведен при спробі встановити стару версію продукту, якщо в системі наявна більш нова версія

Окрім того цей ключ також може мати наступні атрибути:
- `AllowDowngrades` - дозволяє встановлення більш старої версії продукту, що може бути корисним для тестування, але не рекомендується для використання в продуктивному середовищі;
- `IgnoreRemoveFailure` - дозволяє проходження процесу оновлення навіть у випадку, коли не вдалося видалити попередню версію продукту;
- `MigrateFeatures` - дозволяє зберігати налаштування властивостей компонентів при оновленні версії продукту;
- `Schedule` - визначає порядок виконання дій під час процесу оновлення (може бути "afterInstallExecute" або "afterInstallFinalize").
___
~~~wxs
<MediaTemplate />
~~~
**MediaTemplate** - ключ який використовується для створення Windows Installer пакетів (.msi). Він описує структуру і компоненти установочних пакетів. Може використовуватись для опису як інсталяційні файли мають розміщуватись на носії. Але може бути корисним і при встановленні безпосередньо з пам'яті пристрою. Наприклад атрибут EmbedCab дозволяє вказати, що всі файли інсталяції мають бути вбудовані безпосередньо в .msi файл

*MediaTemplate* може мати наступні атрибути: 
- `EmbedCab`: Встановлює значення yes або no для вбудовування кабінет-файлів (CAB-файлів) безпосередньо в .msi файл. За замовчуванням, значення встановлено як yes;
- `CompressionLevel`: Встановлює рівень стиснення для кабінет-файлів. Значення можуть бути: none, low, medium, high, maximum. За замовчуванням, значення встановлено як high;

Наступні аргументи є застарілими та використовуються дуже рідко оскільки зазвичай установочні пакети розміщуються на одному медіа-носії або передаються через мережу
- `DiskPrompt`: Встановлює текстовий рядок, який відображається користувачу, коли потрібно вставити наступний диск або медіа-носій під час встановлення. За замовчуванням використовується системний текстовий рядок;
- `VolumeLabel`: Встановлює текстовий рядок, який буде використовуватися як мітка для медіа-дисків або медіа-носіїв, на яких розміщується установочний пакет;
- `MaximumUncompressedMediaSize`: Встановлює максимальний розмір кабінет-файлів в мегабайтах, які не стиснуті. За замовчуванням, значення встановлено як 0, що означає, що розмір не обмежений.

## <a name="r3">Локалізація</a>
Розглянемо локалізацію на прикладі додавання української мови:
- У файлі Product.wxs для ключа Language встановлюємо значення 1058, яке відповідає українській мові. Нажаль повнго списку цих ключів не знайшов навіть в офіційній документації. В цілому цей ключ використовується для встановлення мови локалізації для вихідного коду, що включає в себе текстові рядки, назви файлів та директорій, повідомлення, ярлики, та інші тексти.
- В налаштуваннях проекту *Solution Explorer -> Properties* на закладці *Build* в поле *Cultures to build* необхідно додати uk-UA. Повний перелік мов можна знайти тут: https://wixtoolset.org/docs/v3/wixui/wixui_localization/. В цілому дане налаштування використовується для вибору культур, для яких буде створюватися вихідний код та мовні пакети
- Далі необхідно налаштувати підтримку вибраної мови в інтерфейсі встановлення (для показу повідомлень та написів на кнопках та інших елементах). Для цього:
    - З репозиторія, з якого було викачано інсталер WiX (https://wixtoolset.org/) завантажумо архів wix311-debug.zip.
    - Розпаковуємо архів та переходимо до папки: wix311-debug.zip\src\ext\UIExtension\wixlib\
    - Копіюємо з неї файл WixUI_uk-UA.wxl в папку з проектом
    - Додаємо файл до проекту *Add -> Existing Item*

## <a name="r4">Додавання діалогових вікон</a>
Існує два варіанти додавання діалогових вікон. Самостійно або з використанням готового набору діалогових вікон.

### <a name="r4_1">Самостійне додавання</a>

### <a name="r4_2">Використання готового набору</a>

Щоб скористатись готовими діалоговими вікнами їх спочатку необхідно додати до проекту. Для цього:
- Додаємо в проекті посилання на *"C:\Program Files (x86)\WiX Toolset v3.11\bin\WixUIExtension.dll"* за допомогою *Add -> Reference*
- В кінці розділу Product вказуємо який набір буде використовуватись

~~~wix
<Property Id="WIXUI_INSTALLDIR" Value="INSTALLLOCATION" ></Property>
<UIRef Id="WixUI_InstallDir"/>
~~~

Розберемо додані рядки:
- `Id="WIXUI_INSTALLDIR"` - ідентифікатор (по суті тип) який дозволяє зберігти шлях, вибраний користувачем для встановлення додатку
- `INSTALLLOCATION` -назва змінної, в якій зберігається вибраний шлях встановлення додатку (можна вибрати будь яку іншу назву)
- `UIRef` - по суті посилання на доданий раніше файл *WixUIExtension.dll*
- `Id="WixUI_InstallDir"` - набір елементів інтерфейсу, що відповідають етапу інсталяції додатку

В ціломуіснують наступні набори елементів інтерфейсу:
1. **WixUI_Advanced** - набір елементів управління для забезпечення більш розширених можливостей інсталяції, включаючи діалоги вибору властивостей, вибору компонентів та мов
2. **WixUI_Basic** - простий набір елементів управління, який містить діалоги для вибору мови та каталогу встановлення
3. **WixUI_InstallDir** - набір елементів управління, який містить діалог для вибору каталогу встановлення
4. **WixUI_FeatureTree** - набір елементів управління, який містить діалог для вибору функцій, які користувач може встановити або не встановити
5. **WixUI_Minimal** - мінімальний набір елементів управління, який містить лише діалог вибору каталогу встановлення.
6. **WixUI_Mondo** - набір елементів управління, який містить діалоги для вибору мови, каталогу встановлення, вибору функцій та налаштування опцій встановлення.
7. **WixUI_ProgressOnly** - набір елементів управління, який містить лише діалог відображення ходу встановлення.
8. **WixUI_Simple** - простий набір елементів управління, який містить діалоги для вибору мови та каталогу встановлення, а також діалог завершення встановлення.
9. **WixUI_Web** - набір елементів управління, який містить діалоги для вибору мови, каталогу встановлення, вибору функцій та введення налаштувань зв'язку з веб-сервером.

## <a name="r6">Посилання</a>
1. Стаття на хабрі: "Створення інсталятора за допомогою WiX. Частина 1" - https://habr.com/ru/articles/68616/
2. Послідовність встановлення WiX - https://www.educba.com/install-wix/ 
3. Документація по Product - https://wixtoolset.org/docs/v3/xsd/wix/product/
4. Туторіал по WiX - https://www.firegiant.com/wix/tutorial/